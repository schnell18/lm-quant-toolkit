)
View(combined_ppl)
qnt_csvs <- c(
"data/result-quant_hqq-20240908203349.csv",
"data/result-quant_awq-20240914000139.csv",
"data/result-quant_llm_13B-awq2-20241021095905.csv",
"data/result-quant_gptq-20240908183702.csv",
"data/result-quant_llm_4bit_dense1-mxq-20241003204414.csv",
"data/result-quant_llm_3bit_dense1-mxq-20241004133334.csv",
"data/result-quant_llm-8bit-gptq-20241020031331.csv"
)
qnt_dir <- path.expand("data/qnt")
qnt_fps <- dir(
path = qnt_dir,
pattern = ".*\\.csv$",
full.names = TRUE
)
names(qnt_fps) <- basename(qnt_fps)
combined_qnt <- ldply(
qnt_fps,
read.csv,
stringsAsFactors = FALSE,
.id = "source"
) |>
select(
model, algo, config, quant_duration
)
combined <- combined_ppl |>
left_join(combined_qnt, join_by(model, algo, config)) |>
left_join(combined_stor, join_by(model, algo, config)) |>
mutate(
algo = ifelse(startsWith(config, "mxq-"), "mxq", algo),
config = ifelse(startsWith(config, "mxq-"), substr(config, 5, nchar(config)), config),
quant_duration = ifelse(quant_duration.x > 0, quant_duration.x, quant_duration.y)
) |>
left_join(model_params, join_by(model)) |>
mutate(
bpp = sapply(config, calc_bpp)
) |>
select(!c("quant_duration.x", "quant_duration.y")) |>
distinct(model, algo, config, .keep_all = TRUE) |>
relocate(bpp, .after = config)
View(combined)
library(tidyverse)
library(ggthemes)
library(ggbreak)
library(readr)
all_cols <- c(
"model", "algo", "config",
"bpp", "ppl_wikitext", "ppl_c4"
)
df_all <- read_csv("data/combined.csv") |>
select(all_of(all_cols)) |>
mutate(
model = factor(
model,
levels = c("Llama-2-7b-hf", "Meta-Llama-3-8B", "Llama-2-13b-hf"),
labels = c("Llama-2-7B", "Llama-3-8B", "Llama-2-13B")
),
algo = factor(
algo,
levels = c("mxq", "fp16", "awq", "gptq", "bnb", "hqq"),
labels = c("MXQ", "FP16", "AWQ", "GPTQ", "BnB", "HQQ"),
)
)
df_wikitxt_all <- df_all |>
rename(ppl = ppl_wikitext)
df_c4_all <- df_all |>
rename(ppl = ppl_c4)
model_name <- "Llama-2-7B"
df_wikitxt <- df_wikitxt_all |>
filter(
grepl(model_name, model) & bpp >= 2.5
)
all_cols <- c(
"model", "algo", "config",
"bpp", "ppl_wikitext", "ppl_c4"
)
df_all <- read_csv("data/combined.csv") |>
select(all_of(all_cols)) |>
mutate(
model = factor(
model,
levels = c("Llama-2-7b-hf", "Meta-Llama-3-8B", "Llama-2-13b-hf"),
labels = c("Llama-2-7B", "Llama-3-8B", "Llama-2-13B")
),
algo = factor(
algo,
levels = c("mxq", "fp16", "awq", "gptq", "bnb", "hqq"),
labels = c("MXQ", "FP16", "AWQ", "GPTQ", "BnB", "HQQ"),
)
)
library(tidyverse)
library(ggthemes)
library(ggbreak)
library(readr)
all_cols <- c(
"model", "algo", "config",
"bpp", "ppl_wikitext", "ppl_c4"
)
df_all <- read_csv("data/combined.csv") |>
select(all_of(all_cols)) |>
mutate(
model = factor(
model,
levels = c("Llama-2-7b-hf", "Meta-Llama-3-8B", "Llama-2-13b-hf"),
labels = c("Llama-2-7B", "Llama-3-8B", "Llama-2-13B")
),
algo = factor(
algo,
levels = c("mxq", "fp16", "awq", "gptq", "bnb", "hqq"),
labels = c("MXQ", "FP16", "AWQ", "GPTQ", "BnB", "HQQ"),
)
)
df_wikitxt_all <- df_all |>
rename(ppl = ppl_wikitext)
df_c4_all <- df_all |>
rename(ppl = ppl_c4)
model_name <- "Llama-2-7B"
df_wikitxt <- df_wikitxt_all |>
filter(
grepl(model_name, model) & bpp >= 2.5
)
min_ppl <- min(df_wikitxt$ppl)
min_bpp <- min(df_wikitxt$bpp)
plt5 <- ggplot(
subset(df_wikitxt, algo != "MXQ"),
aes(x = bpp, y = ppl),
) +
geom_point(
data = subset(df_wikitxt, algo == "MXQ"),
size = 0.5,
aes(shape = algo, color = algo, y = ppl)
) +
geom_point(size = 1.5, aes(shape = algo, color = algo, y = ppl)) +
geom_hline(
yintercept = min_ppl * 1.02,
linetype = "dashed",
size = 0.1,
color = "blue"
) +
geom_hline(
yintercept = min_ppl * 1.01,
linetype = "dashed",
size = 0.1,
color = "blue"
) +
geom_hline(
yintercept = min_ppl,
linetype = "dashed",
size = 0.1,
color = "blue"
) +
annotate("text", x = 15.8, y = min_ppl * 1.00, label = "FP16") +
scale_x_break(c(5.5, 15.6)) +
scale_x_continuous(
limits = c(2.8, 16.2),
breaks = seq(2.8, 5.5, 0.20),
sec.axis = sec_axis(~ 100 * (16 - .) / 16, name = "% Memery Reduction")
) +
scale_y_continuous(
limits = c(min_ppl * 0.99, min_ppl * 1.20),
breaks = seq(5.18, 5.18 * 1.20, 0.20),
sec.axis = sec_axis(~ 100 * (. - 5.18) / 5.18, name = "% Degradation")
) +
labs(x = "", y = "Perplexity") +
theme_gray(base_size = 14) +
guides(
shape = guide_legend(title = "Method:"),
color = guide_legend(title = "Method:")
) +
theme(
axis.title.x = element_blank(),
legend.position = "bottom",
legend.text = element_text(size = 14),
legend.title = element_text(size = 14)
) +
facet_wrap(~model, scales = "free") +
scale_color_solarized()
plt5
pdf.options(reset = TRUE, onefile = FALSE)
ggsave(
paste0("mxq-wikitext-", model_name, ".pdf"),
plot = plt5, width = 8, height = 5
)
df_c4 <- df_c4_all |>
filter(
grepl(model_name, model) & bpp >= 2.5
)
min_ppl <- min(df_c4$ppl)
min_bpp <- min(df_c4$bpp)
plt6 <- ggplot(
subset(df_c4, algo != "MXQ"),
aes(x = bpp, y = ppl),
) +
geom_point(
data = subset(df_c4, algo == "MXQ"),
size = 0.5,
aes(shape = algo, color = algo, y = ppl)
) +
geom_point(size = 1.5, aes(shape = algo, color = algo, y = ppl)) +
geom_hline(
yintercept = min_ppl * 1.02,
linetype = "dashed",
size = 0.1,
color = "blue"
) +
geom_hline(
yintercept = min_ppl * 1.01,
linetype = "dashed",
size = 0.1,
color = "blue"
) +
geom_hline(
yintercept = min_ppl,
linetype = "dashed",
size = 0.1,
color = "blue"
) +
annotate("text", x = 15.8, y = min_ppl * 1.00, label = "FP16") +
scale_x_break(c(5.5, 15.6)) +
scale_x_continuous(
limits = c(2.8, 16.2),
breaks = seq(2.8, 5.5, 0.20),
sec.axis = sec_axis(~ 100 * (16 - .) / 16, name = "% Memery Reduction")
) +
scale_y_continuous(
limits = c(min_ppl * 0.99, min_ppl * 1.20),
breaks = seq(6.95, 6.95 * 1.20, 0.25),
sec.axis = sec_axis(~ 100 * (. - 6.95) / 6.95, name = "% Degradation")
) +
labs(x = "Bit Budget", y = "Perplexity") +
theme_gray(base_size = 14) +
guides(
shape = guide_legend(title = "Method:"),
color = guide_legend(title = "Method:")
) +
theme(
legend.position = "bottom",
legend.text = element_text(size = 14),
legend.title = element_text(size = 14)
) +
facet_wrap(~model, scales = "free") +
scale_color_solarized()
plt6
library(tidyverse)
library(ggthemes)
library(ggbreak)
library(readr)
all_cols <- c(
"model", "algo", "config",
"bpp", "ppl_wikitext", "ppl_c4"
)
df_all <- read_csv("data/combined.csv") |>
select(all_of(all_cols)) |>
filter(
algo == "mxq" | algo == "pct5" | algo == "fp16" | algo == "awq" | algo == "hqq"
) |>
mutate(
model = factor(
model,
levels = c("Llama-2-7b-hf", "Meta-Llama-3-8B", "Llama-2-13b-hf"),
labels = c("Llama-2-7B", "Llama-3-8B", "Llama-2-13B")
),
algo = factor(
algo,
levels = c("mxq", "pct5", "fp16", "awq", "gptq", "bnb", "hqq"),
labels = c("MXQ", "PCT5", "FP16", "AWQ", "GPTQ", "BnB", "HQQ"),
)
)
df_wikitxt_all <- df_all |>
rename(ppl = ppl_wikitext)
df_c4_all <- df_all |>
rename(ppl = ppl_c4)
model_name <- "Llama-2-13B"
df_wikitxt <- df_wikitxt_all |>
filter(
model == model_name & bpp >= 2.5
)
min_ppl <- min(df_wikitxt$ppl)
min_bpp <- min(df_wikitxt$bpp)
plt1 <- ggplot(
subset(df_wikitxt, algo != "MXQ"),
aes(x = bpp, y = ppl),
) +
geom_point(
data = subset(df_wikitxt, algo == "MXQ"),
size = 0.5,
aes(shape = algo, color = algo, y = ppl)
) +
geom_point(size = 1.5, aes(shape = algo, color = algo, y = ppl)) +
geom_hline(
yintercept = min_ppl * 1.02,
linetype = "dashed",
size = 0.1,
color = "blue"
) +
geom_hline(
yintercept = min_ppl * 1.01,
linetype = "dashed",
size = 0.1,
color = "blue"
) +
geom_hline(
yintercept = min_ppl,
linetype = "dashed",
size = 0.1,
color = "blue"
) +
annotate("text", x = 15.8, y = min_ppl * 1.00, label = "FP16") +
scale_x_break(c(5.5, 15.6)) +
scale_x_continuous(
limits = c(2.8, 16.2),
breaks = seq(2.8, 5.5, 0.20),
sec.axis = sec_axis(~ 100 * (16 - .) / 16, name = "% Memery Reduction")
) +
scale_y_continuous(
limits = c(min_ppl * 0.99, min_ppl * 1.20),
breaks = seq(4.63, 4.63 * 1.20, 0.20),
sec.axis = sec_axis(~ 100 * (. - 4.63) / 4.63, name = "% Degradation")
) +
labs(x = "Bit Budget", y = "Perplexity") +
theme_gray(base_size = 14) +
guides(
shape = guide_legend(title = "Method:"),
color = guide_legend(title = "Method:")
) +
theme(
legend.position = "bottom",
legend.text = element_text(size = 14),
legend.title = element_text(size = 14)
) +
facet_wrap(~model, scales = "free") +
scale_color_solarized()
plt1
library(tidyverse)
library(ggthemes)
library(ggbreak)
library(readr)
all_cols <- c(
"model", "algo", "config",
"bpp", "ppl_wikitext", "ppl_c4"
)
df_all <- read_csv("data/combined.csv") |>
select(all_of(all_cols)) |>
filter(
algo == "mxq" | algo == "pct5" | algo == "pct6" | algo == "fp16" | algo == "awq" | algo == "hqq"
) |>
mutate(
model = factor(
model,
levels = c("Llama-2-7b-hf", "Meta-Llama-3-8B", "Llama-2-13b-hf"),
labels = c("Llama-2-7B", "Llama-3-8B", "Llama-2-13B")
),
algo = factor(
algo,
levels = c("mxq", "pct5", "pct6", "fp16", "awq", "gptq", "bnb", "hqq"),
labels = c("MXQ", "PCT5", "PCT6", "FP16", "AWQ", "GPTQ", "BnB", "HQQ"),
)
)
df_wikitxt_all <- df_all |>
rename(ppl = ppl_wikitext)
df_c4_all <- df_all |>
rename(ppl = ppl_c4)
model_name <- "Llama-2-13B"
df_wikitxt <- df_wikitxt_all |>
filter(
model == model_name & bpp >= 2.5
)
min_ppl <- min(df_wikitxt$ppl)
min_bpp <- min(df_wikitxt$bpp)
plt1 <- ggplot(
subset(df_wikitxt, algo != "MXQ"),
aes(x = bpp, y = ppl),
) +
geom_point(
data = subset(df_wikitxt, algo == "MXQ"),
size = 0.5,
aes(shape = algo, color = algo, y = ppl)
) +
geom_point(size = 1.5, aes(shape = algo, color = algo, y = ppl)) +
geom_hline(
yintercept = min_ppl * 1.02,
linetype = "dashed",
size = 0.1,
color = "blue"
) +
geom_hline(
yintercept = min_ppl * 1.01,
linetype = "dashed",
size = 0.1,
color = "blue"
) +
geom_hline(
yintercept = min_ppl,
linetype = "dashed",
size = 0.1,
color = "blue"
) +
annotate("text", x = 15.8, y = min_ppl * 1.00, label = "FP16") +
scale_x_break(c(5.5, 15.6)) +
scale_x_continuous(
limits = c(2.8, 16.2),
breaks = seq(2.8, 5.5, 0.20),
sec.axis = sec_axis(~ 100 * (16 - .) / 16, name = "% Memery Reduction")
) +
scale_y_continuous(
limits = c(min_ppl * 0.99, min_ppl * 1.20),
breaks = seq(4.63, 4.63 * 1.20, 0.20),
sec.axis = sec_axis(~ 100 * (. - 4.63) / 4.63, name = "% Degradation")
) +
labs(x = "Bit Budget", y = "Perplexity") +
theme_gray(base_size = 14) +
guides(
shape = guide_legend(title = "Method:"),
color = guide_legend(title = "Method:")
) +
theme(
legend.position = "bottom",
legend.text = element_text(size = 14),
legend.title = element_text(size = 14)
) +
facet_wrap(~model, scales = "free") +
scale_color_solarized()
plt1
library(tidyverse)
library(ggthemes)
library(readr)
all_cols1 <- c(
"model",
"algo",
"config",
"bpp",
"load_mem_allot"
)
all_cols2 <- c(
"model",
"algo",
"config.x",
"bpp",
"load_mem_allot"
)
df_all <- read_csv("data/combined.csv")
df_wo_mxq <- df_all |>
filter(algo != "mxq") |>
select(all_of(all_cols1))
df_fp16 <- df_all |>
filter(algo == "fp16")
df_baseline <- df_all |>
filter(algo == "hqq") |>
left_join(df_fp16, by = c("model"), suffix = c(".x", "")) |>
select(all_of(all_cols2)) |>
rename(
config = config.x,
)
df_hqq <- df_wo_mxq |> filter(algo == "hqq" & !str_detect(config, "^mxq"))
df_mxq <- df_all |> filter(algo == "mxq" | algo == "pct5" | algo == "pct6")
df_mxq1 <- df_hqq |>
left_join(
df_mxq,
suffix = c(".x", ""),
join_by(model, bpp)
) |>
select(c("model", "algo", "config.x", "bpp", "load_mem_allot")) |>
rename(
config = config.x
)
disp <- bind_rows(df_wo_mxq, df_baseline, df_mxq1) |>
filter(str_detect(config, "^b4")) |>
mutate(
model = factor(
model,
levels = c("Llama-2-7b-hf", "Meta-Llama-3-8B", "Llama-2-13b-hf"),
labels = c("Llama-2-7B", "Llama-3-8B", "Llama-2-13B")
),
algo = factor(algo, levels = (c("awq", "gptq", "hqq", "mxq", "pct5", "pct6", "bnb", "fp16"))),
config = factor(config, levels = (c("b4g32", "b4g64", "b4g128")))
) |>
filter(algo != "bnb")
plt1 <- ggplot(disp, aes(x = algo, y = load_mem_allot, fill = algo)) +
geom_col(aes(x = load_mem_allot, y = algo), show.legend = FALSE) +
geom_text(
aes(0, y = algo, label = toupper(algo)),
hjust = 0,
nudge_x = 0.3,
colour = "white",
size = 3
) +
labs(y = "Algorithm", x = "GPU Memory(GiB)") +
scale_x_continuous(
limits = c(0, 22),
breaks = seq(0, 22, by = 4),
expand = c(0, 0),
position = "bottom"
) +
scale_y_discrete(expand = expansion(add = c(0, 0.5))) +
theme(
panel.background = element_rect(fill = "white"),
panel.grid.major.x = element_line(color = "#A8BAC4", size = 0.3),
axis.ticks.length = unit(0, "mm"),
axis.title = element_blank(),
axis.text.y = element_blank()
) +
facet_grid(config ~ model) +
scale_color_solarized()
plt1
source("~/study/aut-study/master-thesis/data-vis/plot-mxq-gap.R")
source("~/study/aut-study/master-thesis/data-vis/plot-mem-consumption.R")
source("~/study/aut-study/master-thesis/data-vis/plot-quant-cfg-diff.R")
final_plot1
source("~/study/aut-study/master-thesis/data-vis/plot-quant-cfg-diff.R")
source("~/study/aut-study/master-thesis/data-vis/plot-quant-cfg-diff.R")
